# Инструкция по настройке деплоя

## Настройка GitHub Secrets

Для работы автоматического деплоя необходимо настроить следующие секреты в GitHub:

1. Перейдите в настройки репозитория: **Settings** → **Secrets and variables** → **Actions**
2. Добавьте следующие секреты:

### Обязательные секреты:

- **`SSH_HOST`** - IP адрес или доменное имя сервера (например: `192.168.1.100` или `example.com`)
- **`SSH_USER`** - Имя пользователя для SSH подключения (например: `deploy` или `root`)
- **`SSH_PRIVATE_KEY`** - Приватный SSH ключ для подключения к серверу
- **`DEPLOY_PATH`** - Путь к директории приложения на сервере (например: `/var/www/html` или `/home/deploy/app`)

## Генерация SSH ключа

Если у вас еще нет SSH ключа для деплоя:

```bash
# На вашем локальном компьютере
ssh-keygen -t ed25519 -C "github-actions-deploy" -f ~/.ssh/github_deploy

# Скопируйте публичный ключ на сервер
ssh-copy-id -i ~/.ssh/github_deploy.pub user@your-server.com

# Или вручную добавьте публичный ключ в ~/.ssh/authorized_keys на сервере
cat ~/.ssh/github_deploy.pub >> ~/.ssh/authorized_keys
```

**Важно:** В GitHub Secrets добавьте содержимое **приватного ключа** (`~/.ssh/github_deploy`), а не публичного!

## Настройка сервера

### Требования на сервере:

1. **PHP 8.4** с расширениями: mbstring, xml, bcmath, pdo, pdo_mysql
2. **Composer** установлен глобально
3. **Node.js** (опционально, если нужна сборка на сервере)
4. **SSH доступ** с правами на запись в директорию приложения
5. **Права sudo** (для перезагрузки PHP-FPM, если необходимо)

### Первоначальная настройка на сервере:

```bash
# Создайте директорию для приложения
mkdir -p /var/www/html
cd /var/www/html

# Скопируйте .env файл вручную (первый раз)
# Убедитесь, что файл .env настроен правильно

# Установите правильные права
chmod -R 755 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache
```

## Что делает деплой

1. ✅ Запускается только после успешного прохождения всех тестов
2. ✅ Запускается только при push в ветки `main` или `master`
3. ✅ Собирает фронтенд ассеты (npm build)
4. ✅ Копирует файлы на сервер через rsync (исключая node_modules, vendor, storage, .env)
5. ✅ Устанавливает/обновляет Composer зависимости на сервере
6. ✅ Запускает миграции базы данных
7. ✅ Очищает и кеширует конфигурацию, маршруты, представления
8. ✅ Оптимизирует приложение
9. ✅ Устанавливает правильные права доступа
10. ✅ Перезагружает PHP-FPM (если доступно)

## Исключения при деплое

Следующие файлы/директории **не копируются** на сервер:
- `.git` - репозиторий Git
- `.github` - конфигурация GitHub Actions
- `node_modules` - устанавливаются на сервере при необходимости
- `.env` - файл окружения (должен быть настроен вручную на сервере)
- `storage` - директория хранилища (остается на сервере)
- `vendor` - устанавливается через Composer на сервере
- `tests` - тесты не нужны в production

## Ручной деплой

Если нужно задеплоить вручную:

```bash
# На сервере
cd /var/www/html
git pull origin main
composer install --no-dev --optimize-autoloader
php artisan migrate --force
php artisan optimize
```

## Troubleshooting

### Проблема: Permission denied при SSH подключении
- Проверьте, что публичный ключ добавлен в `~/.ssh/authorized_keys` на сервере
- Проверьте права на файл: `chmod 600 ~/.ssh/authorized_keys`
- Проверьте права на директорию: `chmod 700 ~/.ssh`

### Проблема: rsync не может скопировать файлы
- Проверьте права пользователя на целевую директорию
- Убедитесь, что путь `DEPLOY_PATH` указан правильно

### Проблема: Composer не найден на сервере
- Установите Composer глобально: `curl -sS https://getcomposer.org/installer | php && mv composer.phar /usr/local/bin/composer`

### Проблема: PHP-FPM не перезагружается
- Это не критично, команда выполняется с `|| true`, чтобы не прервать деплой
- Перезагрузите PHP-FPM вручную: `sudo systemctl reload php8.4-fpm`

